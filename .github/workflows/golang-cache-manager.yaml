name: Reusable Golang Cache Manager 

on:
  workflow_call:
    inputs:
      branch:
        type: string
        description: 'Branch name.'
        default: main
        required: true
      app-name:
        type: string
        description: 'Target to run.'
        required: true
      go-version:
        type: string
        description: 'Go version to use.'
        required: true
    secrets:
      GLOBAL_PAT:
        required: true

jobs:
  build-tests-cache:
    runs-on: ubuntu-latest
    env:
      architecture: arm64
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch || 'main' }}
      - name: Configure Git for Private Modules
        run: git config --global url."https://${{ secrets.GLOBAL_PAT }}:x-oauth-basic@github.com".insteadOf "https://github.com"
      - name: Go Cache Preflights
        id: cache-init
        run: |
          RUNNER_OS=${{ runner.os }}
          TARGET=$(find . -name go.mod | wc -l | awk '{print ($1>1)?"${{ inputs.app-name }}":"*"}')
          if [ ${{ inputs.app-name }} != "*" ]; then
            GO_VERSION_LONG=${{ inputs.go-version }}
            GO_VERSION=$(echo $GO_VERSION_LONG | cut -d'.' -f1-2)
            CACHE_KEY="golang-v${GO_VERSION}-${RUNNER_OS,,}-${{ env.architecture }}-tests-${{ inputs.app-name }}-checksum-$(echo ${{ hashFiles('**/go.sum') }} | cut -c 1-6)"
          else
            GO_VERSION_LONG=$(grep '^go ' go.mod | awk '{print $2}')
            GO_VERSION=$(echo $GO_VERSION_LONG | cut -d'.' -f1-2)
            CACHE_KEY="golang-v${GO_VERSION}-${RUNNER_OS,,}-${{ env.architecture }}-tests-checksum-$(echo ${{ hashFiles('**/go.sum') }} | cut -c 1-6)"
          fi
          echo "target=${TARGET}" >> "$GITHUB_OUTPUT"
          echo "go-version-long=${GO_VERSION_LONG}" >> "$GITHUB_OUTPUT"
          echo "go-version=${GO_VERSION}" >> "$GITHUB_OUTPUT"
          echo "go-build=$(go env GOCACHE)" >> "$GITHUB_OUTPUT"
          echo "go-mod=$(go env GOMODCACHE)" >> "$GITHUB_OUTPUT"
          echo "cache-key=${CACHE_KEY}" >> "$GITHUB_OUTPUT"
      - name: Go Cache Restore
        id: go-cache-restore
        uses: actions/cache@v4
        with:
          path: |
            ${{ steps.cache-init.outputs.go-build }}
            ${{ steps.cache-init.outputs.go-mod }}
          key: ${{ steps.cache-init.outputs.cache-key }}
      # - name: Go Cache Check 
      #   id: cache-check
      #   if: steps.cache-init.outputs.target != '*' && inputs.app-name == '*' 
      #   run: exit 1
      # - name: Go Cache Clean-up
      #   if: steps.go-cache-restore.outputs.cache-hit != 'true'
      #   run: rm -rf ${{ steps.cache-init.outputs.go-build }} ${{ steps.cache-init.outputs.go-mod }}
      - uses: actions/setup-go@v2
        if: steps.go-cache-restore.outputs.cache-hit != 'true'
        with:
          go-version: ${{ steps.cache-init.outputs.go-version-long }}
      - name: Go Run Tests 
        if: steps.go-cache-restore.outputs.cache-hit != 'true'
        run: |
          if [ "${{ inputs.app-name }}" != "*" ]; then
            make ${{ format('test-{0}', inputs.app-name) }}
          else
            make $(grep '^test-' [Mm]akefile | head -1 | cut -d' ' -f1 | tr -d ':')
          fi
        env:
          GOPRIVATE: "github.com/infralight/*,github.com/gofireflyio/*"

  build-app-cache:
    runs-on: ubuntu-latest
    env:
      architecture: arm64
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch || 'main' }}
      - name: Configure Git for Private Modules
        run: git config --global url."https://${{ secrets.GLOBAL_PAT }}:x-oauth-basic@github.com".insteadOf "https://github.com"
      - name: Go Cache Preflights
        id: cache-init
        run: |
          RUNNER_OS=${{ runner.os }}
          TARGET=$(find . -name go.mod | wc -l | awk '{print ($1>1)?"${{ inputs.app-name }}":"*"}')
          if [ ${{ inputs.app-name }} != "*" ]; then
            GO_VERSION_LONG=${{ inputs.go-version }}
            GO_VERSION=$(echo $GO_VERSION_FULL | cut -d'.' -f1-2)
            CACHE_KEY="golang-v${GO_VERSION}-${RUNNER_OS,,}-${{ env.architecture }}-build-${{ inputs.app-name }}-checksum-$(echo ${{ hashFiles('**/go.sum') }} | cut -c 1-6)"
          else
            GO_VERSION_LONG=$(grep '^go ' go.mod | awk '{print $2}')
            GO_VERSION=$(echo $GO_VERSION_FULL | cut -d'.' -f1-2)
            CACHE_KEY="golang-v${GO_VERSION}-${RUNNER_OS,,}-${{ env.architecture }}-build-checksum-$(echo ${{ hashFiles('**/go.sum') }} | cut -c 1-6)"
          fi
          echo "target=${TARGET}" >> "$GITHUB_OUTPUT"
          echo "go-version-long=${GO_VERSION_LONG}" >> "$GITHUB_OUTPUT"
          echo "go-version=${GO_VERSION}" >> "$GITHUB_OUTPUT"
          echo "go-build=$(go env GOCACHE)" >> "$GITHUB_OUTPUT"
          echo "go-mod=$(go env GOMODCACHE)" >> "$GITHUB_OUTPUT"
          echo "cache-key=${CACHE_KEY}" >> "$GITHUB_OUTPUT"
      - name: Go Cache Restore
        id: go-cache-restore
        uses: actions/cache@v4
        with:
          path: |
            ${{ steps.cache-init.outputs.go-build }}
            ${{ steps.cache-init.outputs.go-mod }}
          key: ${{ steps.cache-init.outputs.cache-key }}
      # - name: Go Cache Clean-up
      #   if: steps.go-cache-restore.outputs.cache-hit != 'true'
      #   run: rm -rf ${{ steps.cache-init.outputs.go-build }} ${{ steps.cache-init.outputs.go-mod }}
      - uses: actions/setup-go@v2
        if: steps.go-cache-restore.outputs.cache-hit != 'true' 
        with:
          go-version: ${{ steps.cache-init.outputs.go-version-long }}
      - name: Go Download and Build All 
        if: steps.cache-init.outputs.target == '*' && steps.go-cache-restore.outputs.cache-hit != 'true' 
        env:
          GOPRIVATE: "github.com/infralight/*,github.com/gofireflyio/*"
          GOOS: linux
          GOARCH: arm64
        run: |
          go mod tidy
          go mod download
          go build -o /dev/null ./...
          du -sh ${{ steps.cache-init.outputs.go-build }}
          du -sh ${{ steps.cache-init.outputs.go-mod }}
      - name: Go Build
        if: steps.go-cache-restore.outputs.cache-hit != 'true' && env.architecture == 'arm64'
        env:
          GOPRIVATE: "github.com/infralight/*,github.com/gofireflyio/*"
        run: |

          if [ "${{ inputs.app-name }}" != "*" ]; then
            make ci-build-${{ inputs.app-name }} VERSION=${{ steps.vars.outputs.tag }} BUILD_TIME=${{ steps.vars.outputs.date }} COMMIT_SHA=${GITHUB_SHA} WORK_DIR=${GITHUB_WORKSPACE}
            exit 0
          fi

          # Run all targets
          targets="ci-build-cache $(grep '^ci-build-' [Mm]akefile | cut -d' ' -f1 | tr -d ':')"
          for target in $targets; do
              # Check if target exists in makefile
              if ! make --dry-run "$target" &>/dev/null; then
                continue 
              fi

              COMMAND=$(make --dry-run "$target" | sed 's/GOARCH\=amd64/GOARCH\=arm64/ig')
              if [[ "$COMMAND" != *"GOARCH=arm64"* ]]; then
                  COMMAND=$(echo "$COMMAND" | sed -E 's/go\s+build/GOARCH\=arm64 go build/')
              fi
              echo "$COMMAND"
              if bash -c "$COMMAND" 2>/dev/null; then
                  break
              fi
          done

